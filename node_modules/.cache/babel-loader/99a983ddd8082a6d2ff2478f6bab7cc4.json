{"remainingRequest":"D:\\pc端clone\\iqiu\\node_modules\\babel-loader\\lib\\index.js!D:\\pc端clone\\iqiu\\node_modules\\eslint-loader\\index.js??ref--13-0!D:\\pc端clone\\iqiu\\src\\utils\\chat.js","dependencies":[{"path":"D:\\pc端clone\\iqiu\\src\\utils\\chat.js","mtime":1594000643103},{"path":"D:\\pc端clone\\iqiu\\node_modules\\cache-loader\\dist\\cjs.js","mtime":499162500000},{"path":"D:\\pc端clone\\iqiu\\node_modules\\babel-loader\\lib\\index.js","mtime":499162500000},{"path":"D:\\pc端clone\\iqiu\\node_modules\\eslint-loader\\index.js","mtime":499162500000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:aW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMuYXJyYXkuam9pbiI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLmFycmF5LnNsaWNlIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMucGFyc2UtaW50IjsKaW1wb3J0ICJyZWdlbmVyYXRvci1ydW50aW1lL3J1bnRpbWUiOwppbXBvcnQgX2FzeW5jVG9HZW5lcmF0b3IgZnJvbSAiRDovcGNcdTdBRUZjbG9uZS9pcWl1L25vZGVfbW9kdWxlcy9AYmFiZWwvcnVudGltZS9oZWxwZXJzL2VzbS9hc3luY1RvR2VuZXJhdG9yIjsKCi8vIGltcG9ydCBBViBmcm9tICdsZWFuY2xvdWQtc3RvcmFnZScgIC8vIOWtmOWCqOacjeWKoQp2YXIgQVYgPSByZXF1aXJlKCdsZWFuZW5naW5lJyk7CgppbXBvcnQgeyByZWFsVGltZSwgTWVzc2FnZSB9IGZyb20gJ0AvdXRpbHMvbGVhbmNsb3VkLmpzJzsKaW1wb3J0IHsgbGVhbkNsb3VkU2lnbiB9IGZyb20gJ0AvYXBpL2FwaS5qcyc7CmNvbnNvbGUubG9nKEFWLkNsb3VkLCAnQVYuQ2xvdWRBVi5DbG91ZEFWLkNsb3VkJyk7CnZhciBjdXJyZW50Q29udmVyc2F0aW9uID0gbnVsbDsKZXhwb3J0IGZ1bmN0aW9uIGdldENoYXRSb29tKF94LCBfeDIpIHsKICByZXR1cm4gX2dldENoYXRSb29tLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7Cn0KCmZ1bmN0aW9uIF9nZXRDaGF0Um9vbSgpIHsKICBfZ2V0Q2hhdFJvb20gPSBfYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL3JlZ2VuZXJhdG9yUnVudGltZS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWUoY2xpZW50SWQsIGNoYXRSb29tSW5mbykgewogICAgdmFyIG1hYywgc2lnbmF0dXJlRmFjdG9yeSwgY29udmVyc2F0aW9uU2lnbmF0dXJlRmFjdG9yeTsKICAgIHJldHVybiByZWdlbmVyYXRvclJ1bnRpbWUud3JhcChmdW5jdGlvbiBfY2FsbGVlJChfY29udGV4dCkgewogICAgICB3aGlsZSAoMSkgewogICAgICAgIHN3aXRjaCAoX2NvbnRleHQucHJldiA9IF9jb250ZXh0Lm5leHQpIHsKICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgY29uc29sZS5sb2coJ3Byb2Nlc3MuZW52LlZVRV9BUFBfQ09ORklHX0VOVicsIHByb2Nlc3MuZW52LlZVRV9BUFBfQ09ORklHX0VOVik7IC8vIOe7n+S4gOa3u+WKoCB0YWcgVE9ETyDkupLouKIKICAgICAgICAgICAgLy8gcmV0dXJuIHJlYWxUaW1lLmNyZWF0ZUlNQ2xpZW50KGNsaWVudElkLCB7IHRhZzogJ1BDJyB9KQoKICAgICAgICAgICAgY29uc29sZS5sb2coY2hhdFJvb21JbmZvLCAnY2hhdFJvb21JbmZvJyk7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGNsaWVudElkLCAnY2xpZW50SWQnKTsgLy8gQVYuQ2xvdWQuZGVmaW5lKCdzaWduTG9naW4nLCBhc3luYyByZXF1ZXN0ID0+IHsKICAgICAgICAgICAgLy8gICBjb25zdCB7Y2xpZW50SWR9ID0gcmVxdWVzdC5wYXJhbXMKICAgICAgICAgICAgLy8gICAvLyDov5nph4zlj6/ku6XmiafooYzkuIDkupvmo4DpqozvvIzkvovlpoLmgqjnmoTnlKjmiLfns7vnu5/ph4zpnaLmmK/lkKbmnInljLnphY3ov5nkuKogY2xpZW50SWQg55qE55So5oi377yM5oiW6ICF6K+l55So5oi35a2Y5Zyo5LqO6Ieq5a6a5LmJ55qE6buR5ZCN5Y2V5Lit77yMCiAgICAgICAgICAgIC8vICAgLy8g5L2g5Y+v5Lul5Zyo5q2k5oqb5Ye65byC5bi45p2l5Lit5pat562+5ZCN55qE6L+H56iL77yaCiAgICAgICAgICAgIC8vICAgLy8gdGhyb3cgbmV3IEFWLkNsb3VkLkVycm9yKCdjbGllbnRJZCBibG9ja2VkJykKICAgICAgICAgICAgLy8gICByZXR1cm4gW2YxLmFwcGlkLCBjbGllbnRJZCwgJycsIGYxLnV0Y1RpbWVTdGFtcCwgZjEucmFuZG9tTnVtXQogICAgICAgICAgICAvLyB9KQogICAgICAgICAgICAvLyB2YXIgc2lnbmF0dXJlRmFjdG9yeSA9IGZ1bmN0aW9uIChjbGllbnRJZCkgewogICAgICAgICAgICAvLyAgIC8vIGFwcGlkOmNsaWVudGlkOnNvcnRlZF9tZW1iZXJfaWRzOnRpbWVzdGFtcDpub25jZQogICAgICAgICAgICAvLyAgIHJldHVybiBBVi5DbG91ZC5ycGMoJ3NpZ25Mb2dpbicsIHsKICAgICAgICAgICAgLy8gICAgIC8vIGFwcGlkOiBmMS5hcHBpZCwKICAgICAgICAgICAgLy8gICAgIGNsaWVudElkOiBjbGllbnRJZCwKICAgICAgICAgICAgLy8gICAgIC8vIHRpbWVzdGFtcDogZjEudXRjVGltZVN0YW1wLAogICAgICAgICAgICAvLyAgICAgLy8gbm9uY2U6IGYxLnJhbmRvbU51bSwKICAgICAgICAgICAgLy8gICAgIC8vIHNpZ246IGYxLnNpZ24KICAgICAgICAgICAgLy8gICB9KTsgLy8gQVYuQ2xvdWQucnBjIOi/lOWbnuS4gOS4qiBQcm9taXNlCiAgICAgICAgICAgIC8vIH07CiAgICAgICAgICAgIC8vIEFWLkNsb3VkLmRlZmluZSgnc2lnbkxvZ2luJywgYXN5bmMgcmVxdWVzdCA9PiB7CiAgICAgICAgICAgIC8vICAgY29uc3Qge2NsaWVudElkfSA9IHJlcXVlc3QucGFyYW1zCiAgICAgICAgICAgIC8vICAgLy8g6L+Z6YeM5Y+v5Lul5omn6KGM5LiA5Lqb5qOA6aqM77yM5L6L5aaC5oKo55qE55So5oi357O757uf6YeM6Z2i5piv5ZCm5pyJ5Yy56YWN6L+Z5LiqIGNsaWVudElkIOeahOeUqOaIt++8jOaIluiAheivpeeUqOaIt+WtmOWcqOS6juiHquWumuS5ieeahOm7keWQjeWNleS4re+8jAogICAgICAgICAgICAvLyAgIC8vIOS9oOWPr+S7peWcqOatpOaKm+WHuuW8guW4uOadpeS4reaWreetvuWQjeeahOi/h+eoi++8mgogICAgICAgICAgICAvLyAgIC8vIHRocm93IG5ldyBBVi5DbG91ZC5FcnJvcignY2xpZW50SWQgYmxvY2tlZCcpCiAgICAgICAgICAgIC8vICAgcmV0dXJuIHNpZ24oICh0aW1lc3RhbXAsIG5vbmNlKSA9PiBbZjEuYXBwaWQsIGNsaWVudElkLCAnJywgdGltZXN0YW1wLCBub25jZV0pCiAgICAgICAgICAgIC8vICAgLy8gcmV0dXJuIHt0aW1lc3RhbXA6ZjEudXRjVGltZVN0YW1wLCBub25jZTpmMS5yYW5kb21OdW0sc2lnbmF0dXJlOmYxLnNpZ259CiAgICAgICAgICAgIC8vIH0pCiAgICAgICAgICAgIC8vIHRlc3QgbWVuZwoKICAgICAgICAgICAgbWFjID0gY2xpZW50SWQ7CgogICAgICAgICAgICBzaWduYXR1cmVGYWN0b3J5ID0gZnVuY3Rpb24gc2lnbmF0dXJlRmFjdG9yeShjbGllbnRJZCkgewogICAgICAgICAgICAgIGlmIChjbGllbnRJZC5zbGljZSg1LCA2KSA9PT0gJ1YnKSB7CiAgICAgICAgICAgICAgICBtYWMgPSBjbGllbnRJZC5zdWJzdHIoMTMpOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgcmV0dXJuIGxlYW5DbG91ZFNpZ24oY2hhdFJvb21JbmZvLCBtYWMpLnRoZW4oZnVuY3Rpb24gKHJlcykgewogICAgICAgICAgICAgICAgaWYgKHJlcy5jb2RlID09PSAwKSB7CiAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCflvLnluZXnrb7lkI3mjqXlj6MwJywgcmVzKTsKICAgICAgICAgICAgICAgICAgdmFyIHRpbWVzdGFtcCA9IHBhcnNlSW50KHJlcy5kYXRhWzBdLnV0Y1RpbWVTdGFtcCk7CiAgICAgICAgICAgICAgICAgIHZhciBub25jZSA9IHJlcy5kYXRhWzBdLnJhbmRvbU51bTsKICAgICAgICAgICAgICAgICAgdmFyIHNpZ25hdHVyZSA9IHJlcy5kYXRhWzBdLnNpZ247CiAgICAgICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgICAgdGltZXN0YW1wOiB0aW1lc3RhbXAsCiAgICAgICAgICAgICAgICAgICAgbm9uY2U6IG5vbmNlLAogICAgICAgICAgICAgICAgICAgIHNpZ25hdHVyZTogc2lnbmF0dXJlCiAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygn5aSx6LSlJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBjb252ZXJzYXRpb25TaWduYXR1cmVGYWN0b3J5ID0gZnVuY3Rpb24gY29udmVyc2F0aW9uU2lnbmF0dXJlRmFjdG9yeShjaGF0Um9vbUluZm8pIHsKICAgICAgICAgICAgICByZXR1cm4gbGVhbkNsb3VkU2lnbihjaGF0Um9vbUluZm8sIG1hYykudGhlbihmdW5jdGlvbiAocmVzKSB7CiAgICAgICAgICAgICAgICBpZiAocmVzLmNvZGUgPT09IDApIHsKICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ+W8ueW5leetvuWQjeaOpeWPozEnLCByZXMpOwogICAgICAgICAgICAgICAgICB2YXIgdGltZXN0YW1wID0gcGFyc2VJbnQocmVzLmRhdGFbMV0udXRjVGltZVN0YW1wKTsKICAgICAgICAgICAgICAgICAgdmFyIG5vbmNlID0gcmVzLmRhdGFbMV0ucmFuZG9tTnVtOwogICAgICAgICAgICAgICAgICB2YXIgc2lnbmF0dXJlID0gcmVzLmRhdGFbMV0uc2lnbjsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICAgICB0aW1lc3RhbXA6IHRpbWVzdGFtcCwKICAgICAgICAgICAgICAgICAgICBub25jZTogbm9uY2UsCiAgICAgICAgICAgICAgICAgICAgc2lnbmF0dXJlOiBzaWduYXR1cmUKICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCflpLHotKUnKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHJldHVybiBfY29udGV4dC5hYnJ1cHQoInJldHVybiIsIHJlYWxUaW1lLmNyZWF0ZUlNQ2xpZW50KGNsaWVudElkLCB7CiAgICAgICAgICAgICAgc2lnbmF0dXJlRmFjdG9yeTogc2lnbmF0dXJlRmFjdG9yeSwKICAgICAgICAgICAgICBjb252ZXJzYXRpb25TaWduYXR1cmVGYWN0b3J5OiBjb252ZXJzYXRpb25TaWduYXR1cmVGYWN0b3J5CiAgICAgICAgICAgIH0pLnRoZW4oZnVuY3Rpb24gKGN1cnJlbnRDbGllbnQpIHsKICAgICAgICAgICAgICBjb25zb2xlLmxvZygnY3VycmVudENsaWVudCcsIGN1cnJlbnRDbGllbnQpOwogICAgICAgICAgICAgIHJldHVybiBjdXJyZW50Q2xpZW50LmdldENvbnZlcnNhdGlvbihjaGF0Um9vbUluZm8pOwogICAgICAgICAgICB9KS50aGVuKGZ1bmN0aW9uIChjb252ZXJzYXRpb24pIHsKICAgICAgICAgICAgICByZXR1cm4gY29udmVyc2F0aW9uLmpvaW4oKTsKICAgICAgICAgICAgfSkudGhlbihmdW5jdGlvbiAoY29udmVyc2F0aW9uKSB7CiAgICAgICAgICAgICAgY3VycmVudENvbnZlcnNhdGlvbiA9IGNvbnZlcnNhdGlvbjsKICAgICAgICAgICAgICByZXR1cm4gY29udmVyc2F0aW9uOwogICAgICAgICAgICB9KVsiY2F0Y2giXShmdW5jdGlvbiAoZXJyKSB7CiAgICAgICAgICAgICAgY29uc29sZS5sb2coJ+i/nuaOpeebtOaSremXtOWksei0pScsIGVycik7CiAgICAgICAgICAgIH0pKTsKCiAgICAgICAgICBjYXNlIDc6CiAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICByZXR1cm4gX2NvbnRleHQuc3RvcCgpOwogICAgICAgIH0KICAgICAgfQogICAgfSwgX2NhbGxlZSk7CiAgfSkpOwogIHJldHVybiBfZ2V0Q2hhdFJvb20uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKfQoKZXhwb3J0IGZ1bmN0aW9uIHNlbmRNc2codXNlcklucHV0LCB1c2VySW5mbykgewogIHZhciBuZXdNZXNzYWdlID0gbmV3IE1lc3NhZ2UodXNlcklucHV0KTsKICBuZXdNZXNzYWdlLnNldEF0dHJpYnV0ZXModXNlckluZm8pOwogIHJldHVybiBjdXJyZW50Q29udmVyc2F0aW9uLnNlbmQobmV3TWVzc2FnZSkudGhlbihmdW5jdGlvbiAobWVzc2FnZSkgewogICAgcmV0dXJuIG1lc3NhZ2U7CiAgfSlbImNhdGNoIl0oZnVuY3Rpb24gKGVycm9yKSB7CiAgICB0aHJvdyBlcnJvcjsKICB9KTsKfQ=="},{"version":3,"sources":["D:/pc端clone/iqiu/src/utils/chat.js"],"names":["AV","require","realTime","Message","leanCloudSign","console","log","Cloud","currentConversation","getChatRoom","clientId","chatRoomInfo","process","env","VUE_APP_CONFIG_ENV","mac","signatureFactory","slice","substr","then","res","code","timestamp","parseInt","data","utcTimeStamp","nonce","randomNum","signature","sign","conversationSignatureFactory","createIMClient","currentClient","getConversation","conversation","join","err","sendMsg","userInput","userInfo","newMessage","setAttributes","send","message","error"],"mappings":"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","sourcesContent":["// import AV from 'leancloud-storage'  // 存储服务\r\nconst AV = require('leanengine')\r\nimport { realTime, Message } from '@/utils/leancloud.js'\r\nimport { leanCloudSign } from '@/api/api.js'\r\n\r\nconsole.log(AV.Cloud, 'AV.CloudAV.CloudAV.Cloud');\r\nlet currentConversation = null\r\n\r\nexport async function getChatRoom(clientId, chatRoomInfo) {\r\n  console.log('process.env.VUE_APP_CONFIG_ENV',process.env.VUE_APP_CONFIG_ENV)\r\n  // 统一添加 tag TODO 互踢\r\n  // return realTime.createIMClient(clientId, { tag: 'PC' })\r\n  console.log(chatRoomInfo, 'chatRoomInfo');\r\n  console.log(clientId, 'clientId');\r\n\r\n  // AV.Cloud.define('signLogin', async request => {\r\n  //   const {clientId} = request.params\r\n  //   // 这里可以执行一些检验，例如您的用户系统里面是否有匹配这个 clientId 的用户，或者该用户存在于自定义的黑名单中，\r\n  //   // 你可以在此抛出异常来中断签名的过程：\r\n  //   // throw new AV.Cloud.Error('clientId blocked')\r\n  //   return [f1.appid, clientId, '', f1.utcTimeStamp, f1.randomNum]\r\n  // })\r\n  // var signatureFactory = function (clientId) {\r\n  //   // appid:clientid:sorted_member_ids:timestamp:nonce\r\n  //   return AV.Cloud.rpc('signLogin', {\r\n  //     // appid: f1.appid,\r\n  //     clientId: clientId,\r\n  //     // timestamp: f1.utcTimeStamp,\r\n  //     // nonce: f1.randomNum,\r\n  //     // sign: f1.sign\r\n  //   }); // AV.Cloud.rpc 返回一个 Promise\r\n  // };\r\n  // AV.Cloud.define('signLogin', async request => {\r\n  //   const {clientId} = request.params\r\n  //   // 这里可以执行一些检验，例如您的用户系统里面是否有匹配这个 clientId 的用户，或者该用户存在于自定义的黑名单中，\r\n  //   // 你可以在此抛出异常来中断签名的过程：\r\n  //   // throw new AV.Cloud.Error('clientId blocked')\r\n  //   return sign( (timestamp, nonce) => [f1.appid, clientId, '', timestamp, nonce])\r\n  //   // return {timestamp:f1.utcTimeStamp, nonce:f1.randomNum,signature:f1.sign}\r\n  // })\r\n\r\n  // test meng\r\n  let mac = clientId\r\n  var signatureFactory = function (clientId) {\r\n    if(clientId.slice(5,6) === 'V'){\r\n      mac = clientId.substr(13)\r\n    }\r\n    return leanCloudSign(chatRoomInfo, mac).then((res) => {\r\n      if (res.code === 0) {\r\n        console.log('弹幕签名接口0',res)\r\n        const timestamp = parseInt(res.data[0].utcTimeStamp)\r\n        const nonce = res.data[0].randomNum\r\n        const signature = res.data[0].sign\r\n        return {timestamp, nonce, signature}\r\n      } else {\r\n        console.log('失败')\r\n      }\r\n    })\r\n  };\r\n  var conversationSignatureFactory = function(chatRoomInfo) {\r\n\r\n    return leanCloudSign(chatRoomInfo, mac).then((res) => {\r\n      if (res.code === 0) {\r\n        console.log('弹幕签名接口1',res)\r\n        const timestamp = parseInt(res.data[1].utcTimeStamp)\r\n        const nonce = res.data[1].randomNum\r\n        const signature = res.data[1].sign\r\n        return {timestamp, nonce, signature}\r\n      } else {\r\n        console.log('失败')\r\n      }\r\n    })\r\n  };\r\n\r\n  return realTime.createIMClient(clientId, {\r\n    signatureFactory: signatureFactory,\r\n    conversationSignatureFactory: conversationSignatureFactory,\r\n  }).then(function (currentClient) {\r\n    console.log('currentClient',currentClient)\r\n    return currentClient.getConversation(\r\n      chatRoomInfo\r\n    )\r\n  })\r\n    .then(function (conversation) {\r\n      return conversation.join()\r\n    })\r\n    .then(function (conversation) {\r\n      currentConversation = conversation\r\n      return conversation\r\n    })\r\n    .catch(function (err) {\r\n      console.log('连接直播间失败', err)\r\n    })\r\n}\r\n\r\nexport function sendMsg(userInput, userInfo) {\r\n  let newMessage = new Message(userInput)\r\n  newMessage.setAttributes(userInfo)\r\n  return currentConversation.send(newMessage)\r\n    .then(function (message) {\r\n      return message\r\n    })\r\n    .catch(function (error) {\r\n      throw (error)\r\n    })\r\n}\r\n"]}]}